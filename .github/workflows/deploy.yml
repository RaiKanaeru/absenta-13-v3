# ========================================
# ABSENTA 13 - Auto Deploy Workflow
# ========================================
# Triggers on push to main branch
# Deploys to server via SSH
# ========================================

name: ğŸš€ Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  NODE_VERSION: '20'

jobs:
  # ==========================================
  # BUILD - Build frontend
  # ==========================================
  build:
    name: ğŸ“¦ Build Application
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ”¨ Build frontend
        run: npm run build
        env:
          NODE_ENV: production

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1

  # ==========================================
  # DEPLOY - Deploy to server
  # ==========================================
  deploy:
    name: ğŸš€ Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: ğŸ”‘ Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ“‹ Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸš€ Deploy to server
        run: |
          echo "ğŸš€ Starting deployment..."
          
          # Sync files to server (excluding node_modules, .git, etc)
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude '.env' \
            --exclude 'logs' \
            --exclude 'backups' \
            --exclude 'temp' \
            --exclude 'downloads' \
            --exclude 'reports' \
            --exclude 'public/uploads' \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/
          
          echo "âœ… Files synced successfully!"

      - name: ğŸ”§ Install dependencies & restart
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            
            echo "ğŸ“¦ Installing dependencies..."
            npm ci --omit=dev --legacy-peer-deps
            
            echo "ğŸ”„ Restarting application..."
            if command -v pm2 &> /dev/null; then
              pm2 restart absenta-backend || pm2 start ecosystem.config.js --env production
            elif command -v docker &> /dev/null; then
              docker-compose up -d --build absenta-app
            else
              echo "âš ï¸ No PM2 or Docker found, please restart manually"
            fi
            
            echo "âœ… Deployment complete!"

      - name: ğŸ Deployment summary
        run: |
          echo "=========================================="
          echo "   ğŸ‰ DEPLOYMENT SUCCESSFUL!"
          echo "=========================================="
          echo "ğŸ“¦ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸŒ Server: ${{ secrets.SERVER_HOST }}"
          echo "=========================================="
